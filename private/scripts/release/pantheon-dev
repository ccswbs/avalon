#!/bin/bash

# Safe mode
set -xeuo pipefail

# Utilities
PATH=$PATH:/opt/terminus/vendor/bin

# Environment
SITE=${SITE:-ug-avalon}
ENV=${ENV:-dev}
TEMP=${TEMP:-/tmp}
UPSTREAM_URL=https://oauth:$SYSTEM_ACCESSTOKEN@ccswds.visualstudio.com/_git/Avalon

# TODO: Copy live database to release environment

# TODO: Export configuration and commit

# TODO: Merge release environment with master

# Clone site repository
cd $TEMP
rm -rf $SITE
GIT_URL=$(terminus connection:info $SITE.$ENV --field=git_url)
git clone $GIT_URL $SITE

# Merge release tag/commit
cd $SITE
git pull $UPSTREAM_URL $BUILD_SOURCEVERSION
git push origin HEAD

# Wait for Pantheon to sync code changes
sleep 15

# Rollback previous migration
terminus drush $SITE.$ENV -- migrate-rollback --all </dev/null

# Import config
terminus drush $SITE.$ENV -- config-import -y </dev/null

# Migrate content
terminus drush $SITE.$ENV -- migrate-import --all </dev/null
